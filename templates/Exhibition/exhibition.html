{% extends 'Public/base.html' %}
{% load crispy_forms_filters %}
{% load static %}
{% load crispy_forms_tags %}

{% block extra_head %}
    <title>Exhibition</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
    <script src="https://unpkg.com/konva@9/konva.min.js"></script>

    <link rel="stylesheet" href="{% static 'css/Exhibition/exhibition.css' %}">
{% endblock %}

{% block extra_nav_icons %}
    <!-- å¯¼èˆªæ é¢å¤–æŒ‰é”®-->
    {% if user.is_authenticated and user_type == 'Manager' %}
        <li class="nav-item">
            <a class="nav-link" href="{% url 'Statistic:statistic' %}"><i class="fas fa-chart-bar"></i>
                Statistics</a>
        </li>
    {% endif %}
    {% if user.is_authenticated and user_type != 'Exhibitor' and user_type != 'Guest' %}
        <li class="nav-item">
            <a class="nav-link" href="{% url 'Layout:layout' %}"><i class="fas fa-edit"></i> Layout</a>
        </li>
    {% endif %}
{% endblock %}

{% block breadcrumbs %}
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'Venue:home' %}">Home</a></li>
            <li class="breadcrumb-item"><a
                    href="{% url 'Venue:venue' exhibition.venue.id %}">{{ exhibition.venue.name }}</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ exhibition.name }}</li>
        </ol>
    </nav>
{% endblock %}

{% block content %}
    <div id="exhibition-app">

        <div class="d-flex justify-content-between align-items-center mb-3" id="exhibition-header">
            <div id="exhibition-name" class="exhibition-text logo-title">
                Current Exhibition: {{ exhibition.name }}
            </div>
            <div class="dropdown">
                <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownFloorMenu"
                        data-bs-toggle="dropdown" aria-expanded="false">
                    Current Sector: [[ layers.length > 0 ? layers[0].name : 'Loading...' ]]
                </button>
                <ul class="dropdown-menu" aria-labelledby="dropdownFloorMenu">
                    {% for sector in sectors %}
                        {% comment %}ä½ å…ˆåˆ«æ€¥, è¿™é‡Œæ˜¯Pycharmçš„æ¨¡æ¿è¯­æ³•å‡ºç°äº†é—®é¢˜, è¿™é‡Œå…¶å®æ˜¯å¯ä»¥æ­£å¸¸è¿è¡Œçš„{% endcomment %}
                        <li><a class="dropdown-item" href="#"
                               @click="toggleSector({{ sector.pk }})">Sector {{ sector.name }}</a></li>
                    {% endfor %}
                </ul>
            </div>
        </div>

        <div id="konva-container"></div>
        <!-- ç”¨äºå±•ç¤ºåœ¨ç”»æ¿ä¸Šé€‰ä¸­çš„KonvaElementæ‰€åœ¨çš„Layer -->
        <div id="tooltip"
             style="position: absolute; display: none; background: lightgrey; padding: 5px; border-radius: 3px;"></div>


        <!-- Floating Action Button -->
        {% if user.is_authenticated and user_type == 'Exhibitor' %}
            <a @click="openBoothApplyModal" class="btn btn-success rounded-circle shadow" id="createBoothApply"
               style="position: fixed; bottom: 170px; right: 10px; z-index: 1040; width: 60px; height: 60px; display: flex;
           justify-content: center; align-items: center; font-size: 30px;" title="Apply Booth">
                ğŸ“
            </a>
        {% elif user.is_authenticated and user_type == 'Organizer' %}
            <a class="btn btn-success rounded-circle shadow"
               style="position: fixed; bottom: 170px; right: 10px; z-index: 1040; width: 60px; height: 60px; display: flex; justify-content: center; align-items: center; font-size: 30px;"
               href="{% url 'Inventory:inventory' 'exhibition' exhibition.id %}" title="View Inventory">
                ğŸ“¦
            </a>
        {% endif %}
        {% if is_owner %}
            <a @click="cancelExhibition()" class="btn btn-success rounded-circle shadow" id="cancelExhibition"
               style="background-color: #c9302c;border: #c9302c; position: fixed; bottom: 100px; right: 10px; z-index: 1040; width: 60px; height: 60px; display: flex; justify-content: center; align-items: center; font-size: 30px;"
               title="Cancel Exhibition">
                âŒ
            </a>
        {% endif %}

        {#        <a class="btn btn-success rounded-circle shadow" id="filter-booths-btn"#}
        {#           style="position: fixed; bottom: 100px; right: 10px; z-index: 1040; width: 60px; height: 60px; display: flex; justify-content: center; align-items: center; font-size: 30px;"#}
        {#           @click="openFilterModal;" title="Filter Booths">#}
        {#            <i class="fas fa-filter mt-1"></i>#}
        {#        </a>#}

        <!-- å±•è§ˆåˆ—è¡¨ -->
        <div class="table-responsive" style="margin: 1rem; user-select: none">
            <table class="table table-hover text-white">
                <thead class="bg-dark">
                <tr>
                    <th></th>
                    <th>Booth Name</th>
                    <th>Description</th>
                    <th>Exhibitor</th>
                    <th>Sector</th>
                    <th>Start Time</th>
                    <th>End Time</th>
                </tr>
                </thead>
                <tbody>
                {% for booth in booths %}
                    <tr onclick="window.location.href='{% url 'Booth:booth' booth.id %}';"
                        style="cursor: pointer;">
                        <td><img src="{{ booth.image|default:'../../static/images/Public/poster.jpg' }}"
                                 alt="No Poster"
                                 class="booth-img" style="width: 100px; height: 80px;"></td>
                        <td>{{ booth.name }}</td>
                        <td>{{ booth.description }}</td>
                        <td>{{ booth.exhibitor }}</td>
                        <td>{{ booth.sectors }}</td>
                        <td>{{ booth.start_at| date:"Y-m-d H:i" }}</td>
                        <td>{{ booth.end_at| date:"Y-m-d H:i" }}</td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="7" class="text-center text-white">No booths found. ğŸ’¤</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>

        {# ç”³è¯·æ–°å±•å°æ¨¡æ€æ¡† #}
        <div class="modal fade" id="createBoothApplyModal" tabindex="-1" aria-labelledby="createBoothApplyModalLabel"
             aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="createBoothApplyModalLabel">Apply for a New Booth</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="application-form" method="post"
                              action="{% url 'Booth:create_booth_application' %}" enctype="multipart/form-data"
                              class="needs-validation" novalidate>
                            {% csrf_token %}
                            {{ application_form|crispy }}
                            <div id="application-form-container"></div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-success" @click="submitApplication">Apply
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        {# ç­›é€‰å±•å°æ¨¡æ€æ¡† #}
        <div class="modal fade" id="filterBoothsModal" tabindex="-1" aria-labelledby="filterBoothsLabel"
             aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="filterBoothsTitle">Filter Booths</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="filterFrom" method="post" action="{% url 'Exhibition:exhibition' exhibition.pk %}"
                              enctype="multipart/form-data"
                              class="needs-validation" novalidate>
                            {% csrf_token %}
                            {{ filter_form|crispy }}
                            <input type="hidden" name="exhibition_id" id="exhibition_id" value="{{ exhibition.pk }}">
                            <div id="filter-booths-message-container"></div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="submit" class="btn btn-success">Filter Booths</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

    </div>
{% endblock %}

{% block scripts %}
    <script>
        // å–æ¶ˆå±•ä¼š
        function cancelExhibition() {
            const token = document.querySelector('input[name="csrfmiddlewaretoken"]').value;  // è·å– CSRF ä»¤ç‰Œ
            const url = `{% url 'Exhibition:cancel_exhibition' 999 %}`.replace('999', {{ exhibition.pk }});
            const container = document.getElementById('application-container');

            // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
            const confirmed = window.confirm("Are you sure you want to cancel the exhibition?\n\nThis action cannot be undone! ğŸ˜±");

            if (confirmed) {
                axios.post(url, {}, {
                    headers: {
                        'X-CSRFToken': token  // è¯·æ±‚å¤´ä¸­åŒ…å« CSRF ä»¤ç‰Œ
                    }
                }).then(response => {
                    if (response.data.success) {
                        container.innerHTML = `<div class="alert alert-success">${response.data.success}</div>`;
                        setTimeout(() => {
                            window.location.href = `{% url 'Venue:home' %}`;
                        }, 1500);
                    } else {
                        container.innerHTML = `<div class="alert alert-danger">${response.data.error}</div>`;
                        container.style.display = 'block';  // ç¡®ä¿æ¶ˆæ¯å®¹å™¨å¯è§
                    }
                })
                    .catch(error => {
                        // è®°å½•æˆ–å¤„ç†é”™è¯¯
                        console.error(error);
                        container.innerHTML = `<div class="alert alert-danger">${error.response.data.error}</div>`;
                        container.style.display = 'block';  // ç¡®ä¿æ¶ˆæ¯å®¹å™¨å¯è§
                    });
            }
        }

        new Vue({
            el: '#exhibition-app',
            delimiters: ['[[', ']]'], // æ›´æ”¹Vueçš„æ’å€¼è¡¨è¾¾å¼å®šç•Œç¬¦
            data: {
                layers: [],
                stage: null,
                currentElement: null,
            },
            mounted() {
                this.refreshData(0);
            },
            beforeDestroy() {
                if (this.stage) {
                    this.stage.container().removeEventListener('wheel', this.handleWheelZoom);
                }
                window.removeEventListener('resize', this.handleResize);
            },
            methods: {
                // ----------------- æ•°æ®åŠ è½½ -----------------
                refreshData(sectorId) {
                    console.log('Refreshing data...');
                    return axios.get('{% url "Exhibition:refresh_data" %}', {
                        params: {
                            sector_id: sectorId,
                            exhibition_id: {{ exhibition.id }},
                            user_type: '{{ user_type }}',
                        }
                    }).then(response => {
                        if (response.data && response.data.id) {
                            console.log('Data synchronized:', response.data);
                            this.layers = []; // æ¸…ç©ºVueå®ä¾‹çš„layersæ•°ç»„
                            this.layers = [response.data];
                            this.renderKonva(); // é‡æ–°åˆå§‹åŒ–Konva
                        } else {
                            console.error('Unexpected response data:', response.data);
                        }
                    }).catch(error => {
                        console.error('Failed to synchronize data:', error);
                    });
                },

                // ----------------- ä»¥ä¸‹æ˜¯ä¸konva.jsç›¸å…³çš„å‡½æ•° -----------------

                // ----------------- konva.js: åŠ è½½æ•°æ® -----------------
                renderKonva() {
                    console.log('Rendering Konva...');
                    this.stage = new Konva.Stage({
                        container: 'konva-container',
                        width: window.innerWidth * 0.9,
                        height: window.innerHeight * 0.9,
                    });

                    // æ·»åŠ æ»šè½®ç¼©æ”¾äº‹ä»¶ç›‘å¬å™¨
                    this.stage.container().addEventListener('wheel', this.handleWheelZoom);
                    // æ·»åŠ çª—å£å¤§å°å˜åŒ–äº‹ä»¶ç›‘å¬å™¨
                    window.addEventListener('resize', this.handleResize);
                    // æ·»åŠ ç”»æ¿æ‹–æ‹½çš„ç›‘å¬å™¨
                    this.stage.on('mousedown', this.handleMouseDown);
                    this.stage.on('mouseup', this.handleMouseUp);
                    this.stage.on('mousemove', this.handleMouseMove);

                    const loadImage = (url, nodeData, group, element, spaceUnit) => { // ä¿è¯å›¾ç‰‡çš„åŒæ­¥è€Œéå¼‚æ­¥åŠ è½½, è¿™æ ·èƒ½å¤Ÿé¿å…å›¾å±‚çš„ä¹±åº
                        return new Promise((resolve, reject) => {
                            Konva.Image.fromURL(url, (imageNode) => {
                                try {
                                    imageNode.setAttrs(nodeData);
                                    group.add(imageNode);
                                    this.addListenersForElement(imageNode, element, spaceUnit);
                                    resolve(imageNode);
                                } catch (error) {
                                    reject(error);
                                }
                            });
                        });
                    };

                    // é€’å½’å‡½æ•°æ¥å¤„ç†æ¯ä¸ªå±‚çº§çš„SpaceUnitå’Œelements
                    const processLayer = async (spaceUnits, parent) => {
                        for (const spaceUnit of spaceUnits) {
                            // ä½¿ç”¨Groupæ¥æ¨¡æ‹Ÿå±‚åµŒå¥—
                            let group = new Konva.Group();
                            parent.add(group); // å°†å½“å‰å±‚æ·»åŠ åˆ°çˆ¶ç»„ä»¶ä¸­

                            // å¤„ç†å½“å‰SpaceUnitçš„elements
                            for (const element of spaceUnit.elements) {
                                const nodeData = JSON.parse(element.data);
                                if (element.type === 'Image') { // å¦‚æœåŠ è½½çš„æ˜¯å›¾ç‰‡
                                    await loadImage(element.image, nodeData, group, element, spaceUnit);
                                } else {
                                    const node = Konva.Node.create(nodeData, group);
                                    group.add(node);
                                    this.addListenersForElement(node, element, spaceUnit); // æ·»åŠ å˜æ¢å’Œæ‹–æ‹½ç»“æŸçš„äº‹ä»¶ç›‘å¬å™¨
                                }
                            }

                            // å¦‚æœå½“å‰SpaceUnitæœ‰å­å•ä½ï¼Œåˆ™é€’å½’å¤„ç†
                            if (spaceUnit.child_units && spaceUnit.child_units.length > 0) {
                                await processLayer(spaceUnit.child_units, parent);
                            }
                        }
                    };

                    const rootLayer = new Konva.Layer();
                    this.stage.add(rootLayer);
                    processLayer(this.layers, rootLayer); // ä»æ ¹å±‚çº§å¼€å§‹å¤„ç†æ‰€æœ‰å±‚çº§
                    rootLayer.draw();
                },

                addListenersForElement(node, element, parentSpaceUnit) {
                    // æ·»åŠ å³é”®ç‚¹å‡»ç›‘å¬å™¨
                    node.on('contextmenu', (e) => {
                        e.evt.preventDefault();
                        let element = this.findElementByKonvaId(this.layers, node.id());
                        if (element) {
                            this.currentElement = element;
                            // TODO å¯åœ¨æ­¤å¤„è®¾ç½®å³é”®ç”»æ¿ä¸Šçš„Konva Elementåçš„æ“ä½œ(æ¯”å¦‚å¼¹å‡ºæ¨¡æ€æ¡†å¹¶ç»™æ¨¡æ€æ¡†çš„è¡¨å•èµ‹å€¼)
                        }
                    });

                    const tooltip = document.getElementById('tooltip');
                    const showTooltip = (text, evt) => {
                        tooltip.style.display = 'block';
                        tooltip.innerText = text;
                        tooltip.style.backgroundColor = parentSpaceUnit.available ? 'green' : 'red'; // æ ¹æ® Available å±æ€§è®¾ç½®èƒŒæ™¯è‰²
                        const mousePos = this.stage.getPointerPosition();
                        tooltip.style.top = `${mousePos.y + 5}px`;
                        tooltip.style.left = `${mousePos.x + 5}px`;
                    };
                    const hideTooltip = () => {
                        tooltip.style.display = 'none';
                    };

                    // æ·»åŠ é¼ æ ‡æ‚¬æµ®äº‹ä»¶ç›‘å¬å™¨
                    node.on('mouseenter', (evt) => showTooltip(parentSpaceUnit.name, evt));
                    node.on('mouseleave', hideTooltip);
                    node.on('mousemove', (evt) => showTooltip(parentSpaceUnit.name, evt));
                },

                findElementByKonvaId(layers, elementId) {
                    for (let layer of layers) {
                        for (let element of layer.elements) {
                            if (String(element.id) === String(elementId)) {
                                return element;
                            }
                        }
                        if (layer.child_units) {
                            let found = this.findElementByKonvaId(layer.child_units, elementId);
                            if (found) return found;
                        }
                    }
                    return null;
                },

                // ----------------- konva.js: æ§åˆ¶Stageä¸Šçš„äº¤äº’äº‹ä»¶ -----------------

                handleMouseDown(e) {
                    // ç¡®ä¿æ˜¯å·¦é”®ç‚¹å‡»
                    if (e.evt.button === 0) {
                        this.isDragging = true;
                        this.lastPointerPosition = this.stage.getPointerPosition();
                    }
                },

                handleMouseUp() {
                    this.isDragging = false; // åœæ­¢æ‹–åŠ¨
                },

                handleMouseMove(e) {
                    if (this.isDragging) {
                        // è®¡ç®—ç§»åŠ¨è·ç¦»
                        const pointerPosition = this.stage.getPointerPosition();
                        const dx = pointerPosition.x - this.lastPointerPosition.x;
                        const dy = pointerPosition.y - this.lastPointerPosition.y;

                        // æ›´æ–°ä½ç½®
                        this.stage.x(this.stage.x() + dx);
                        this.stage.y(this.stage.y() + dy);

                        // æ›´æ–°æœ€åçš„æŒ‡é’ˆä½ç½®
                        this.lastPointerPosition = pointerPosition;

                        // é‡æ–°æ¸²æŸ“
                        this.stage.batchDraw();
                    }
                },

                handleWheelZoom(event) {
                    // æ£€æŸ¥æ˜¯å¦æŒ‰ä¸‹äº†Ctrlé”®
                    if (event.ctrlKey) {
                        event.preventDefault();

                        const oldScale = this.stage.scaleX();
                        const pointer = this.stage.getPointerPosition();

                        // æ”¾å¤§æˆ–ç¼©å°
                        const scaleBy = 1.1;
                        const newScale = event.deltaY > 0 ? oldScale / scaleBy : oldScale * scaleBy;

                        this.stage.scale({x: newScale, y: newScale});

                        const mousePointTo = {
                            x: (pointer.x - this.stage.x()) / oldScale,
                            y: (pointer.y - this.stage.y()) / oldScale,
                        };

                        const newPos = {
                            x: pointer.x - mousePointTo.x * newScale,
                            y: pointer.y - mousePointTo.y * newScale,
                        };

                        this.stage.position(newPos);
                        this.stage.batchDraw();
                    }
                },

                handleStageClick(e) {
                    if (e.evt.button === 2) { // Right-click to finish polygon drawing
                        e.evt.preventDefault(); // é˜»æ­¢é»˜è®¤ä¸Šä¸‹æ–‡èœå•
                        //this.resetState();
                    }
                },

                handleResize() {
                    const width = window.innerWidth * 0.9;
                    const height = window.innerHeight * 0.91;
                    this.stage.size({width, height});
                },

                // ----------------- å…¶ä»–å‡½æ•° -----------------

                toggleSector(sectorId) { // åˆ‡æ¢æ¥¼å±‚
                    if (this.layers[0].id !== sectorId) {
                        this.refreshData(sectorId);
                    }
                },

                openBoothApplyModal() {
                    const myModal = new bootstrap.Modal(document.getElementById('createBoothApplyModal'));
                    myModal.show(); // æ˜¾ç¤ºæ¨¡æ€æ¡†
                },

                openFilterModal() {
                    const filterModal = new bootstrap.Modal(document.getElementById('filterBoothsModal'));
                    filterModal.show();
                },

                submitApplication() {
                    const formElement = document.getElementById('application-form');
                    const formData = new FormData(formElement);
                    const url = formElement.action;  // ç›´æ¥ä»è¡¨å•å…ƒç´ è·å–action
                    const container = document.getElementById('application-form-container');

                    formData.set('exhib_id', {{ exhibition.pk }}); // æ·»åŠ åœºé¦†ID
                    for (let [key, value] of formData.entries())
                        console.log(key, value);

                    axios.post(url, formData, {
                        headers: {
                            'X-CSRFToken': document.querySelector('input[name="csrfmiddlewaretoken"]').value,  // åœ¨è¯·æ±‚å¤´ä¸­åŒ…å«CSRFä»¤ç‰Œ
                            'Content-Type': 'multipart/form-data'  // å‘é€æ–‡ä»¶æ—¶å¾ˆé‡è¦
                        }
                    }).then(response => {
                        if (response.data.success) {  // æ£€æŸ¥å“åº”ä¸­æ˜¯å¦åŒ…å«â€œsuccessâ€
                            container.innerHTML = `<div class="alert alert-success">${response.data.success}</div>`;
                            const modal = bootstrap.Modal.getInstance(document.getElementById('createBoothApplyModal'));
                            setTimeout(() => {
                                modal.hide();  // éšè—æ¨¡æ€æ¡†
                                window.location.reload();  // é‡æ–°åŠ è½½é¡µé¢ä»¥æ›´æ–°æ¶ˆæ¯åˆ—è¡¨
                            }, 1500);
                        }
                    }).catch(error => {
                        // è®°å½•æˆ–å¤„ç†é”™è¯¯
                        console.error(error);
                        container.innerHTML = `<div class="alert alert-danger">${error.response.data.error}</div>`;
                        container.style.display = 'block';  // Make sure the message container is visible
                    });
                },

                submitFilter() {
                    const filterForm = document.getElementById('filterFrom');
                    const container = document.getElementById('filter-booths-message-container');
                    filterForm.addEventListener("submit", function (e) {
                        e.preventDefault();
                        const formData = new FormData(filterForm);
                        const url = filterForm.action;
                        axios.post(url, formData, {
                            headers: {
                                'X-CSRFToken': document.querySelector('input[name="csrfmiddlewaretoken"]').value,
                                'Content-Type': 'multipart/form-data'
                            }
                        }).then(response => {
                            if (response.data.success) {
                                container.innerHTML = `<div class="alert alert-success">${response.data.success}</div>`;
                                const modal = bootstrap.Modal.getInstance(document.getElementById('filterBoothsModal'));
                                setTimeout(() => {
                                    modal.hide();
                                    window.location.reload();
                                }, 1500);
                            }
                        }).catch(error => {
                            console.error(error);
                            container.innerHTML = `<div class="alert alert-danger">${error.response.data.error}</div>`;
                            container.style.display = 'block';
                        });
                    });
                },

            }
        });

    </script>
{% endblock %}
