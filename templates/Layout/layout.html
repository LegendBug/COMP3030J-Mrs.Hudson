{% extends 'Public/base.html' %}
{% load crispy_forms_filters %}
{% load crispy_forms_tags %}
{% load static %}

{% block extra_head %}
    <title>Venue Layout</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/fabric"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
    <link rel="stylesheet" href="{% static 'css/Layout/layout.css' %}">
    <link rel="stylesheet" href="{% static 'css/Layout/canvas.css' %}">
{% endblock %}

{% block extra_nav_icons %}
    <!-- 在这里添加导航栏里额外的icon-->
    {% if user.is_authenticated and user_type == 'Manager' %}
        <li class="nav-item">
            <a class="nav-link" href="{% url 'Statistic:statistic' %}"><i class="fas fa-chart-bar"></i> Statistics</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="{% url 'Layout:venue_layout' %}"><i class="fas fa-edit"></i> Layout</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="{% url 'Inventory:inventory' %}"><i class="fas fa-warehouse"></i> Inventory</a>
        </li>
    {% endif %}
{% endblock %}


{% block content %}
    <div id="app">
        <!-- Floating Action Button -->
        <button @click="toggleOffcanvas" class="btn btn-primary rounded shadow" id="toggle-offcanvas-btn"
                :style="buttonStyle">
            <i :class="offcanvasOpen ? 'fas fa-chevron-left' : 'fas fa-chevron-right'"></i>
        </button>


        <!-- Offcanvas -->
        <div class="offcanvas offcanvas-start" data-bs-scroll="true" data-bs-backdrop="false" id="offcanvasScrolling"
             tabindex="-1"
             aria-labelledby="offcanvasScrollingLabel"
             :class="{'show': offcanvasOpen}" style="visibility: visible;">

            <div class="offcanvas-header">
                {# 按钮: Return#}
                <button type="button" class="btn btn-secondary" @click="toggleOffcanvas">Return</button>
                {# Dropdown: Floor#}
                <div class="dropdown">
                    <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownFloorMenu"
                            data-bs-toggle="dropdown" aria-expanded="false">
                        Select Floor
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="dropdownFloorMenu">
                        <li><a class="dropdown-item" href="#">Floor 1</a></li>
                        <li><a class="dropdown-item" href="#">Floor 2</a></li>
                        <li><a class="dropdown-item" href="#">Floor 3</a></li>
                    </ul>
                </div>
                {# 按钮: Save#}
                <button type="button" class="btn btn-primary" onclick="saveLayout()">Save</button>
            </div>

            <div class="offcanvas-body">
                
                <!-- Top层级Accordion -->
                <div v-for="(layer, index) in layers" :key="index" class="accordion" id="accordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button" type="button"
                                    :class="{'collapsed': !layer.open}"
                                    @click="toggleLayer(index)"
                                    @contextmenu.prevent="showContextMenu($event, index)">
                                [[ layer.name ]]
                            </button>
                        </h2>
                        <div v-if="layer.open" class="accordion-collapse">
                            <div class="accordion-body">
                                <!-- Recursively display child layers -->
                                <layer-component v-for="(subLayer, subIndex) in layer.layers" :key="subIndex"
                                                 :layer="subLayer" @toggle="toggleLayer"></layer-component>
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>
        </div>

        <!-- 上下文菜单 -->
        <div v-show="isContextMenuVisible" :style="{top: contextMenuY, left: contextMenuX}"
             class="list-group context-menu">
            <a class="list-group-item list-group-item-action" @click="addSubLayer(currentLayer); hideContextMenu()">Add
                Sub-Layer</a>
            <a class="list-group-item list-group-item-action" @click="addElement(currentLayer); hideContextMenu()">Add
                Element </a>
            <a class="list-group-item list-group-item-action" @click="removeLayer(currentLayer); hideContextMenu()">Remove
                Layer</a>
            <a class="list-group-item list-group-item-action" @click="renameLayer(currentLayer); hideContextMenu()">Rename </a>
        </div>


    </div>

{% endblock %}


{% block scripts %}
    {% comment %}<script src="{% static 'js/Layout/layout.js' %}"></script>{% endcomment %}
    <script src="{% static 'js/Layout/canvas.js' %}"></script>
    <script>
        Vue.component('layer-component', {
            props: ['layer'],
            template: `
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button" type="button"
                                :class="{'collapsed': !layer.open}"
                                @click="toggleLayer"
                                @contextmenu.prevent="$emit('contextmenu', layer)">
                            [[ layer.name ]]
                        </button>
                    </h2>
                    <div v-if="layer.open" class="accordion-collapse">
                        <div class="accordion-body">
                            <layer-component v-for="(child, index) in layer.layers" :key="index"
                                             :layer="child" @toggle="toggleLayer" @contextmenu="$emit('contextmenu', child)"></layer-component>
                        </div>
                    </div>
                </div>
            `,
            methods: {
                toggleLayer() {
                    this.layer.open = !this.layer.open;
                }
            }
        });

        new Vue({
            el: '#app',
            delimiters: ['[[', ']]'], // 更改Vue的插值表达式定界符
            data: {
                floor: 1, // 当前楼层,默认为1
                layers: null,
                offcanvasOpen: false,
                isContextMenuVisible: false,
                contextMenuY: 0,
                contextMenuX: 0,
                currentLayer: null,
            },
            mounted() {
                // 监听全局点击事件，用于隐藏上下文菜单
                this.synchronizeData();  // 同步数据当组件挂载
                document.addEventListener('click', this.handleOutsideClick);
            },
            beforeDestroy() {
                // 组件销毁前移除事件监听
                document.removeEventListener('click', this.handleOutsideClick);
            },
            computed: {
                buttonStyle() {
                    return {
                        position: 'fixed',
                        bottom: '45vh',
                        left: this.offcanvasOpen ? '400px' : '10px', // Adjust '400px' as needed
                        zIndex: '1040',
                        width: '25px',
                        height: '50px',
                        display: 'flex',
                        justifyContent: 'center',
                        alignItems: 'center',
                        fontSize: '30px'
                    };
                }
            },
            methods: {
                // 处理全局点击事件
                // ----------------- 全局事件 -----------------
                handleOutsideClick(e) {
                    // 如果点击的不是上下文菜单,则隐藏菜单
                    if (!e.target.closest('.context-menu')) {
                        this.hideContextMenu();
                    }
                },
                // ----------------- 数据加载 -----------------
                 synchronizeData() {
                    axios.get('{% url "Layout:synchronize_data" %}', {
                        params: { floor: this.floor }
                    }).then(response => {
                        if (response.data && response.data.id) {
                            this.layers = [response.data]; // 将root对象包装在数组中
                            this.prepareData(this.layers);
                        } else {
                            console.error('Unexpected response data:', response.data);
                        }
                    }).catch(error => {
                        console.error('Failed to synchronize data:', error);
                    });
                },
                prepareData(layers) {
                    layers.forEach(layer => {
                        Vue.set(layer, 'open', false);  // 确保每个层都有`open`属性
                        if (layer.child_units) {
                            this.prepareData(layer.child_units);  // 递归处理子层
                        }
                    });
                },
                // ----------------- Offcanvas -----------------
                // 控制 Offcanvas 的显示与隐藏
                toggleOffcanvas() {
                    this.offcanvasOpen = !this.offcanvasOpen;
                    this.hideContextMenu(); // 当开启或关闭 Offcanvas 时隐藏上下文菜单
                    let offcanvasElement = document.getElementById('offcanvasScrolling');
                    offcanvasElement.style.visibility = this.offcanvasOpen ? 'visible' : 'hidden';
                },
                // ----------------- Accordions(Layers) -----------------
                // 控制 Layer 的展开与折叠
                toggleLayer(index) {
                    this.layers[index].open = !this.layers[index].open;
                },
                // ----------------- Context Menu -----------------
                showContextMenu(event, index) {
                    event.preventDefault();
                    this.currentLayer = index;
                    this.contextMenuX = event.clientX + 'px'; // 确保使用 px 为单位
                    this.contextMenuY = event.clientY + 'px';
                    this.isContextMenuVisible = true;
                },
                hideContextMenu() {
                    this.isContextMenuVisible = false;
                },
                // ----------------- Layer Group List Menu -----------------
                addSubLayer(index) {
                    
                },
                addElement(index) {

                },
                removeLayer(index) {

                },
                renameLayer(index) {

                },
            }
        });
    </script>
{% endblock %}