{% extends "Public/base.html" %}
{% load crispy_forms_filters %}
{% load static %}
{% load crispy_forms_tags %}

{% block extra_head %}
    <title>Inventory</title>
    {% comment %} <link rel="stylesheet" href="{% static 'css/Inventory/inventory.css' %}">{% endcomment %}
    <link rel="stylesheet" href="{% static 'css/Inventory/inventory_styles.css' %}">
{% endblock %}

{% block extra_nav_icons %}
    <!-- ä½¿ç”¨ Bootstrap Icons -->
    {% if user.is_authenticated and user_type == 'Manager' %}
        <li class="nav-item">
            <a class="nav-link" href="{% url 'Statistic:statistic' %}"><i class="bi bi-bar-chart"></i> Statistics</a>
        </li>
    {% endif %}
    <li class="nav-item">
        <a class="nav-link" href="{% url 'Layout:venue_layout' %}"><i class="bi bi-layout-text-sidebar-reverse"></i> Layout</a>
    </li>
{#    <li class="nav-item">#}
{#        <a class="nav-link" href="{% url 'Inventory:inventory ' %}"><i class="bi bi-box-seam"></i> Inventory</a>#}
{#    </li>#}
{% endblock %}


{% block content %}
    <div class="container mt-3">
        <div class="row">
            {% for category in categories %}
            <div class="col-md-4 col-sm-6 mb-4">
                <div class="card">
                    <img src="{{ category.image.url }}" class="card-img-top" alt="{{ category.name }}" style="height: 200px; object-fit: cover;">
                    <div class="card-body">
                        <h5 class="card-title">{{ category.name }}</h5>
                        <p class="card-text"><strong>Descriptionï¼š</strong>{{ category.description }}</p>
                        <p class="card-text"><small class="text-muted"><strong>Quantityï¼š</strong>{{ category.items_quantity }}</small></p>
                        <p class="card-text"><strong>Is Publicï¼š</strong>{{ category.is_public|yesno:"æ˜¯,å¦" }}</p>
                        <div class="d-flex justify-content-between">
                            <a href="{% url 'Inventory:category_detail' category.pk %}" class="btn btn-info btn-sm">View</a>
                            <a href="{% url 'Inventory:edit-category' category.pk %}" class="btn btn-secondary btn-sm">Modify</a>
                            <button type="button" class="btn btn-danger btn-sm" onclick="confirmDelete({{ category.id }})">Delete</button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- ç”³è¯·åº“å­˜æŒ‰é’® -->
    {% if user.is_authenticated and user_type != 'Manager' %}
        <a href="#" class="btn btn-success rounded-circle shadow" id="add-venue-btn"
           style="position: fixed; bottom: 170px; right: 20px; z-index: 1040; width: 60px; height: 60px; display: flex; justify-content: center; align-items: center; font-size: 30px;"
           onclick="openResApplyModal();" title="Apply for resources">
            ğŸ“
        </a>
    {% endif %}
    <!-- æ·»åŠ åº“å­˜æŒ‰é’® -->
    <a href="#" class="btn btn-success rounded-circle shadow" id="add-venue-btn"
       style="position: fixed; bottom: 100px; right: 20px; z-index: 1040; width: 60px; height: 60px; display: flex; justify-content: center; align-items: center; font-size: 30px;"
       onclick="openAddInventoryModal();" title="Add custom resources">
        +
    </a>

     {# æ·»åŠ åº“å­˜çš„æ¨¡æ€æ¡† #}
    <div class="modal fade" id="addInventoryModal" tabindex="-1" aria-labelledby="addInventoryModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addInventoryModal">Add new resource to the Inventory</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addInventoryForm" method="post"
                          enctype="multipart/form-data" class="needs-validation"
                          novalidate>
                        {% csrf_token %}
                        {{ add_inventory_form|crispy }}
                        <input type="hidden" name="venue_id" id="venue_id" value="{{ current_access.pk }}">
                        <div id="add_inventory-message-container"></div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-success">Add</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    {# ç”³è¯·åº“å­˜çš„æ¨¡æ€æ¡† #}
    <div class="modal fade" id="createResApplyModal" tabindex="-1" aria-labelledby="createResApplyModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createResApplyModal">Apply for New Resources</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="createResApplyForm" method="post"
                          enctype="multipart/form-data" class="needs-validation"
                          novalidate>
                        {% csrf_token %}
                        {{ application_form|crispy }}
                        <input type="hidden" name="venue_id" id="venue_id" value="{{ current_access.pk }}">
                        <div id="application-form-container"></div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-success">Apply</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

{% endblock %}


{% block scripts %}
    <script>
        function confirmDelete(categoryId) {
            if (confirm('Are you sure to delete this category and all its items?')) {
                window.location.href = `{% url 'Inventory:delete-category' 0 %}`.replace('/0/', '/' + categoryId + '/');
            }
        }

        function openAddInventoryModal() {
            const filterModal = new bootstrap.Modal(document.getElementById('addInventoryModal'));
            filterModal.show();
        }

        function openResApplyModal() {
            const filterModal = new bootstrap.Modal(document.getElementById('createResApplyModal'));
            filterModal.show();
        }

        document.addEventListener('DOMContentLoaded', function () {
            const addInventoryForm = document.getElementById('addInventoryForm');
            addInventoryForm.addEventListener('submit', function (e) {
                e.preventDefault();  // é˜»æ­¢è¡¨å•çš„é»˜è®¤æäº¤è¡Œä¸º
                const formData = new FormData(addInventoryForm);
                {% if not exhibition.id %}
                    console.error('Invalid exhibition ID');
                {% else %}
                    console.log('Exhibition ID:', {{ exhibition.id }});
                {% endif %}
                axios.post('{% url 'Inventory:inventory' space_type space_id %}', formData)
                    .then(function (response) {
                        if (response.data.success) { // å¦‚æœæäº¤æˆåŠŸï¼Œæ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                            const addInventoryModal = new bootstrap.Modal(document.getElementById('addInventoryModal'), {});
                            const messageContainer = document.getElementById('add_inventory-message-container');
                            messageContainer.innerHTML = '<div class="alert alert-success">' + response.data.success + '</div>';
                            messageContainer.style.display = 'block';
                            // è®¾ç½®å®šæ—¶å™¨ç­‰å¾…1.5ç§’åå…³é—­æ¨¡æ€æ¡†å¹¶åˆ·æ–°é¡µé¢
                            setTimeout(function () {
                                addInventoryModal.hide(); // å…³é—­æ¨¡æ€æ¡†
                                window.location.reload(); // åˆ·æ–°é¡µé¢
                            }, 1500); // 1500æ¯«ç§’åæ‰§è¡Œ
                        }
                    })
                    .catch(function (error) {
                        let errorMessage = error.message;
                        // å¦‚æœé”™è¯¯ä¸­æœ‰å“åº”å¹¶ä¸”æœ‰æ•°æ®å¹¶ä¸”æ•°æ®ä¸­æœ‰é”™è¯¯ä¿¡æ¯ï¼Œåˆ™ä½¿ç”¨æœåŠ¡å™¨çš„é”™è¯¯ä¿¡æ¯
                        if (error.response && error.response.data && error.response.data.errors) {
                            errorMessage = error.response.data.errors;
                        }
                        document.getElementById('add_inventory-message-container').innerHTML = '<div class="alert alert-danger">Error: ' + errorMessage + '</div>';
                    });
            });

            const createResApplyForm = document.getElementById('createResApplyForm');
            createResApplyForm.addEventListener('submit', function (e) {
                e.preventDefault();  // é˜»æ­¢è¡¨å•çš„é»˜è®¤æäº¤è¡Œä¸º
                const container = document.getElementById('application-form-container');
                const formData = new FormData(createResApplyForm);
                formData.set('booth_id', {{ current_access.pk }}); // è®¾ç½®å±•ä½ID
                for (let pair of formData.entries())
                    console.log(pair[0] + ', ' + pair[1]);
                axios.post('{% url 'Inventory:create_res_application' %}', formData, {
                    headers: {
                        'X-CSRFToken': document.querySelector('input[name="csrfmiddlewaretoken"]').value,  // åœ¨è¯·æ±‚å¤´ä¸­åŒ…å«CSRFä»¤ç‰Œ
                        'Content-Type': 'multipart/form-data'  // å‘é€æ–‡ä»¶æ—¶å¾ˆé‡è¦
                    }
                }).then(response => {
                    if (response.data.success) { // å¦‚æœæäº¤æˆåŠŸï¼Œæ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                        container.innerHTML = `<div class="alert alert-success">${response.data.success}</div>`;
                        const modal = new bootstrap.Modal(document.getElementById('createResApplyModal'));
                        setTimeout(() => {
                            modal.hide();
                            window.location.reload();
                        }, 1500);
                    }
                }).catch(error => {
                    // è®°å½•æˆ–å¤„ç†é”™è¯¯
                    console.error(error);
                    container.innerHTML = `<div class="alert alert-danger">${error.response.data.error}</div>`;
                    container.style.display = 'block';  // Make sure the message container is visible
                });
            });
        });
    </script>
{% endblock %}