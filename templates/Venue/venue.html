{% extends 'Public/base.html' %}
{% load crispy_forms_filters %}
{% load static %}
{% load crispy_forms_tags %}

{% block extra_head %}
    <title>Venue</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"></script>
    <script src="https://unpkg.com/konva@9/konva.min.js"></script>

    <link rel="stylesheet" href="{% static 'css/Venue/venue.css' %}">
{% endblock %}

{% block extra_nav_icons %}
    <!-- Âú®ËøôÈáåÊ∑ªÂä†ÂØºËà™Ê†èÈáåÈ¢ùÂ§ñÁöÑicon-->
    {% if user.is_authenticated and user_type == 'Manager' %}
        <li class="nav-item">
            <a class="nav-link" href="{% url 'Statistic:statistic' %}"><i class="fas fa-chart-bar"></i> Statistics</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="{% url 'Layout:layout' %}"><i class="fas fa-edit"></i> Layout</a>
        </li>
    {% endif %}
{% endblock %}

{% block content %}
    <div id="app">

        <div id="konva-container"></div>

        <!-- Áî®‰∫éÂ±ïÁ§∫Âú®ÁîªÊùø‰∏äÈÄâ‰∏≠ÁöÑKonvaElementÊâÄÂú®ÁöÑLayer -->
        <div id="tooltip"
             style="position: absolute; display: none; background: lightgrey; padding: 5px; border-radius: 3px;"></div>

        <!-- Floating Action Button -->
        {% if user.is_authenticated and user_type == 'Organizer' %}
            <a onclick="openExhibApplyModal()" class="btn btn-success rounded-circle shadow" id="createExhibApply"
               style="position: fixed; bottom: 170px; right: 10px; z-index: 1040; width: 60px; height: 60px; display: flex;
           justify-content: center; align-items: center; font-size: 30px;" title="Apply Exhibition">
                üìù
            </a>
        {% elif user.is_authenticated and user_type == 'Manager' %}
            <a class="btn btn-success rounded-circle shadow"
               style="position: fixed; bottom: 170px; right: 10px; z-index: 1040; width: 60px; height: 60px; display: flex;
           justify-content: center; align-items: center; font-size: 30px;"
               href="{% url 'Inventory:inventory' 'venue' venue.id %}" title="View Inventory">
                üì¶
            </a>
        {% endif %}

        <!-- Â±ïËßàÂàóË°® -->
        <div class="table-responsive" style="margin: 1rem; user-select: none">
            <table class="table table-hover text-white">
                <thead class="bg-dark">
                <tr>
                    <th></th>
                    <th>Exhibition Name</th>
                    <th>Description</th>
                    <th>Organizer</th>
                    <th>Sector</th>
                    <th>Start Time</th>
                    <th>End Time</th>
                    <th>Stage</th>
                </tr>
                </thead>
                <tbody>
                {% for exhibition in exhibitions %}
                    <tr onclick="window.location.href='{% url 'Exhibition:exhibition' exhibition.id %}';"
                        style="cursor: pointer;">
                        <td><img src="{{ exhibition.image|default:'../../static/images/Public/poster.jpg' }}"
                                 alt="No Poster"
                                 class="exhibition-img" style="width: 100px; height: 80px;"></td>
                        <td>{{ exhibition.name }}</td>
                        <td>{{ exhibition.description }}</td>
                        <td>{{ exhibition.organizer }}</td>
                        <td>{{ exhibition.sectors }}</td>
                        <td>{{ exhibition.start_at|date:"Y-m-d H:i" }}</td>
                        <td>{{ exhibition.end_at|date:"Y-m-d H:i" }}</td>
                        <td>{{ exhibition.stage }}</td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="8" class="text-center">No exhibitions found. üí§</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>

        {# Áî≥ËØ∑Êñ∞Â±ïËßàÊ®°ÊÄÅÊ°Ü #}
        <div class="modal fade" id="createExhibApplyModal" tabindex="-1" aria-labelledby="createExhibApplyModalLabel"
             aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="createExhibApplyModalLabel">Apply for a New Exhibition</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="application-form" method="post"
                              action="{% url 'Exhibition:create_exhibit_application' %}" enctype="multipart/form-data"
                              class="needs-validation" novalidate>
                            {% csrf_token %}
                            {{ application_form|crispy }}
                            <div id="application-form-container"></div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-success" onclick="submitApplication()">Apply
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        {# TODO Á®çÂêéÂÆåÊàêÁ≠õÈÄâÊ®°ÊÄÅÊ°Ü #}
        <div class="modal fade" id="filterExhibitionsModal" tabindex="-1" aria-labelledby="filterExhibitionsLabel"
             aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="filterExhibitionsTitle">Filter Exhibitions</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="filterFrom" method="post" action="{% url 'Venue:venue' venue.pk %}"
                              enctype="multipart/form-data"
                              class="needs-validation" novalidate>
                            {% csrf_token %}
                            <input type="hidden" name="venue_id" id="venue_id" value="{{ venue.pk }}">
                            {{ filter_form|crispy }}
                            <div id="filter-exhibitions-message-container"></div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="submit" class="btn btn-success">Filter Exhibitions</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

    </div>
{% endblock %}

{% block scripts %}
    <script>
        new Vue({
            el: '#app',
            delimiters: ['[[', ']]'], // Êõ¥ÊîπVueÁöÑÊèíÂÄºË°®ËææÂºèÂÆöÁïåÁ¨¶
            data: {
                floor: 1, // ÂΩìÂâçÊ•ºÂ±Ç,ÈªòËÆ§‰∏∫1
                layers: [],
                stage: null,
                currentElement: null
            },
            mounted() {
                this.refreshData()
            },
            beforeDestroy() {
                if (this.stage) {
                    this.stage.container().removeEventListener('wheel', this.handleWheelZoom);
                }
                window.removeEventListener('resize', this.handleResize);
            },
            methods: {
                // ----------------- Êï∞ÊçÆÂä†ËΩΩ -----------------
                refreshData() {
                    console.log('Refreshing data...');
                    return axios.get('{% url "Layout:refresh_data" %}', {
                        params: {
                            floor: this.floor,
                            current_access_id: {{ venue.id }},
                            user_type: '{{ user_type }}',
                        }
                    }).then(response => {
                        if (response.data && response.data.id) {
                            console.log('Data synchronized:', response.data);
                            this.layers = []; // Ê∏ÖÁ©∫VueÂÆû‰æãÁöÑlayersÊï∞ÁªÑ
                            this.layers = [response.data];
                            this.renderKonva(); // ÈáçÊñ∞ÂàùÂßãÂåñKonva
                        } else {
                            console.error('Unexpected response data:', response.data);
                        }
                    }).catch(error => {
                        console.error('Failed to synchronize data:', error);
                    });
                },

                // ----------------- ‰ª•‰∏ãÊòØ‰∏ékonva.jsÁõ∏ÂÖ≥ÁöÑÂáΩÊï∞ -----------------

                // ----------------- konva.js: Âä†ËΩΩÊï∞ÊçÆ -----------------
                renderKonva() {
                    console.log('Rendering Konva...');
                    this.stage = new Konva.Stage({
                        container: 'konva-container',
                        width: window.innerWidth * 0.9,
                        height: window.innerHeight * 0.9,
                    });

                    // Ê∑ªÂä†ÊªöËΩÆÁº©Êîæ‰∫ã‰ª∂ÁõëÂê¨Âô®
                    this.stage.container().addEventListener('wheel', this.handleWheelZoom);
                    // Ê∑ªÂä†Á™óÂè£Â§ßÂ∞èÂèòÂåñ‰∫ã‰ª∂ÁõëÂê¨Âô®
                    window.addEventListener('resize', this.handleResize);

                    const loadImage = (url, nodeData, group, element, spaceUnit) => { // ‰øùËØÅÂõæÁâáÁöÑÂêåÊ≠•ËÄåÈùûÂºÇÊ≠•Âä†ËΩΩ, ËøôÊ†∑ËÉΩÂ§üÈÅøÂÖçÂõæÂ±ÇÁöÑ‰π±Â∫è
                        return new Promise((resolve, reject) => {
                            Konva.Image.fromURL(url, (imageNode) => {
                                try {
                                    imageNode.setAttrs(nodeData);
                                    group.add(imageNode);
                                    this.addListenersForElement(imageNode, element, spaceUnit);
                                    resolve(imageNode);
                                } catch (error) {
                                    reject(error);
                                }
                            });
                        });
                    };

                    // ÈÄíÂΩíÂáΩÊï∞Êù•Â§ÑÁêÜÊØè‰∏™Â±ÇÁ∫ßÁöÑSpaceUnitÂíåelements
                    const processLayer = async (spaceUnits, parent) => {
                        for (const spaceUnit of spaceUnits) {
                            // ‰ΩøÁî®GroupÊù•Ê®°ÊãüÂ±ÇÂµåÂ•ó
                            let group = new Konva.Group();
                            parent.add(group); // Â∞ÜÂΩìÂâçÂ±ÇÊ∑ªÂä†Âà∞Áà∂ÁªÑ‰ª∂‰∏≠

                            // Â§ÑÁêÜÂΩìÂâçSpaceUnitÁöÑelements
                            for (const element of spaceUnit.elements) {
                                const nodeData = JSON.parse(element.data);
                                if (element.type === 'Image') { // Â¶ÇÊûúÂä†ËΩΩÁöÑÊòØÂõæÁâá
                                    await loadImage(element.image, nodeData, group, element, spaceUnit);
                                } else {
                                    const node = Konva.Node.create(nodeData, group);
                                    group.add(node);
                                    this.addListenersForElement(node, element, spaceUnit); // Ê∑ªÂä†ÂèòÊç¢ÂíåÊãñÊãΩÁªìÊùüÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
                                }
                            }

                            // Â¶ÇÊûúÂΩìÂâçSpaceUnitÊúâÂ≠êÂçï‰ΩçÔºåÂàôÈÄíÂΩíÂ§ÑÁêÜ
                            if (spaceUnit.child_units && spaceUnit.child_units.length > 0) {
                                await processLayer(spaceUnit.child_units, parent);
                            }
                        }
                    };

                    const rootLayer = new Konva.Layer();
                    this.stage.add(rootLayer);
                    processLayer(this.layers, rootLayer); // ‰ªéÊ†πÂ±ÇÁ∫ßÂºÄÂßãÂ§ÑÁêÜÊâÄÊúâÂ±ÇÁ∫ß
                    rootLayer.draw();
                },

                addListenersForElement(node, element, parentSpaceUnit) {
                    // Ê∑ªÂä†Âè≥ÈîÆÁÇπÂáªÁõëÂê¨Âô®
                    node.on('contextmenu', (e) => {
                        e.evt.preventDefault();
                        let element = this.findElementByKonvaId(this.layers, node.id());
                        if (element) {
                            this.currentElement = element;
                            // TODO ÂèØÂú®Ê≠§Â§ÑËÆæÁΩÆÂè≥ÈîÆÁîªÊùø‰∏äÁöÑKonva ElementÂêéÁöÑÊìç‰Ωú(ÊØîÂ¶ÇÂºπÂá∫Ê®°ÊÄÅÊ°ÜÂπ∂ÁªôÊ®°ÊÄÅÊ°ÜÁöÑË°®ÂçïËµãÂÄº)
                        }
                    });

                    const tooltip = document.getElementById('tooltip');
                    const showTooltip = (text, evt) => {
                        tooltip.style.display = 'block';
                        tooltip.innerText = text;
                        tooltip.style.backgroundColor = parentSpaceUnit.available ? 'green' : 'red'; // Ê†πÊçÆ Available Â±ûÊÄßËÆæÁΩÆËÉåÊôØËâ≤
                        const mousePos = this.stage.getPointerPosition();
                        tooltip.style.top = `${mousePos.y + 5}px`;
                        tooltip.style.left = `${mousePos.x + 5}px`;
                    };

                    const hideTooltip = () => {
                        tooltip.style.display = 'none';
                    };

                    // Ê∑ªÂä†Èº†Ê†áÊÇ¨ÊµÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
                    node.on('mouseenter', (evt) => showTooltip(parentSpaceUnit.name, evt));
                    node.on('mouseleave', hideTooltip);
                    node.on('mousemove', (evt) => showTooltip(parentSpaceUnit.name, evt));
                },

                findElementByKonvaId(layers, elementId) {
                    for (let layer of layers) {
                        for (let element of layer.elements) {
                            if (String(element.id) === String(elementId)) {
                                return element;
                            }
                        }
                        if (layer.child_units) {
                            let found = this.findElementByKonvaId(layer.child_units, elementId);
                            if (found) return found;
                        }
                    }
                    return null;
                },

                // ----------------- konva.js: ÊéßÂà∂Stage‰∏äÁöÑ‰∫§‰∫í‰∫ã‰ª∂ -----------------

                handleWheelZoom(event) {
                    // Ê£ÄÊü•ÊòØÂê¶Êåâ‰∏ã‰∫ÜCtrlÈîÆ
                    if (event.ctrlKey) {
                        event.preventDefault();

                        const oldScale = this.stage.scaleX();
                        const pointer = this.stage.getPointerPosition();

                        // ÊîæÂ§ßÊàñÁº©Â∞è
                        const scaleBy = 1.1;
                        const newScale = event.deltaY > 0 ? oldScale / scaleBy : oldScale * scaleBy;

                        this.stage.scale({x: newScale, y: newScale});

                        const mousePointTo = {
                            x: (pointer.x - this.stage.x()) / oldScale,
                            y: (pointer.y - this.stage.y()) / oldScale,
                        };

                        const newPos = {
                            x: pointer.x - mousePointTo.x * newScale,
                            y: pointer.y - mousePointTo.y * newScale,
                        };

                        this.stage.position(newPos);
                        this.stage.batchDraw();
                    }
                },

                handleStageClick(e) {
                    if (e.evt.button === 2) { // Right-click to finish polygon drawing
                        e.evt.preventDefault(); // ÈòªÊ≠¢ÈªòËÆ§‰∏ä‰∏ãÊñáËèúÂçï
                        this.resetState();
                    }
                },

                handleResize() {
                    const width = window.innerWidth * 0.9;
                    const height = window.innerHeight * 0.91;
                    this.stage.size({width, height});
                },

                // ----------------- ÂÖ∂‰ªñÂáΩÊï∞ -----------------

                changeFloor(floor) { // ÂàáÊç¢Ê•ºÂ±Ç
                    if (this.floor !== floor) {
                        this.floor = floor;
                        this.refreshData();
                    }
                },

                setCurrentElement(element) {
                    console.log('Setting current element:', element);
                    this.currentElement = element;
                },

            }
        });

    </script>


    <script>
        document.addEventListener('DOMContentLoaded', function () {
                function openExhibApplyModal() {
                    const myModal = new bootstrap.Modal(document.getElementById('createExhibApplyModal'));
                    myModal.show(); // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
                }

                function openFilterModal() {
                    const filterModal = new bootstrap.Modal(document.getElementById('filterExhibitionsModal'));
                    filterModal.show();
                }

                function submitApplication() {
                    const formElement = document.getElementById('application-form');
                    const formData = new FormData(formElement);
                    const url = formElement.action;  // Áõ¥Êé•‰ªéË°®ÂçïÂÖÉÁ¥†Ëé∑Âèñaction
                    const container = document.getElementById('application-form-container');

                    formData.set('venue_id', {{ venue.pk }}); // Ê∑ªÂä†Âú∫È¶ÜID
                    for (let [key, value] of formData.entries())
                        console.log(key, value);

                    axios.post(url, formData, {
                        headers: {
                            'X-CSRFToken': document.querySelector('input[name="csrfmiddlewaretoken"]').value,  // Âú®ËØ∑Ê±ÇÂ§¥‰∏≠ÂåÖÂê´CSRF‰ª§Áâå
                            'Content-Type': 'multipart/form-data'  // ÂèëÈÄÅÊñá‰ª∂Êó∂ÂæàÈáçË¶Å
                        }
                    }).then(response => {
                        if (response.data.success) {  // Ê£ÄÊü•ÂìçÂ∫î‰∏≠ÊòØÂê¶ÂåÖÂê´‚Äúsuccess‚Äù
                            container.innerHTML = `<div class="alert alert-success">${response.data.success}</div>`;
                            const modal = bootstrap.Modal.getInstance(document.getElementById('createExhibApplyModal'));
                            setTimeout(() => {
                                modal.hide();  // ÈöêËóèÊ®°ÊÄÅÊ°Ü
                                window.location.reload();  // ÈáçÊñ∞Âä†ËΩΩÈ°µÈù¢‰ª•Êõ¥Êñ∞Ê∂àÊÅØÂàóË°®
                            }, 1500);
                        }
                    }).catch(error => {
                        // ËÆ∞ÂΩïÊàñÂ§ÑÁêÜÈîôËØØ
                        console.error(error);
                        container.innerHTML = `<div class="alert alert-danger">${error.response.data.error}</div>`;
                        container.style.display = 'block';  // Make sure the message container is visible
                    });
                }

                function submitFilter() {
                    const filterForm = document.getElementById('filterFrom');
                    const container = document.getElementById('filter-exhibitions-message-container');
                    filterForm.addEventListener("submit", function (e) {
                        e.preventDefault();
                        const formData = new FormData(filterForm);
                        const url = filterForm.action;
                        axios.post(url, formData, {
                            headers: {
                                'X-CSRFToken': document.querySelector('input[name="csrfmiddlewaretoken"]').value,
                                'Content-Type': 'multipart/form-data'
                            }
                        }).then(response => {
                            if (response.data.success) {
                                container.innerHTML = `<div class="alert alert-success">${response.data.success}</div>`;
                                const modal = bootstrap.Modal.getInstance(document.getElementById('filterExhibitionsModal'));
                                setTimeout(() => {
                                    modal.hide();
                                    window.location.reload();
                                }, 1500);
                            }
                        }).catch(error => {
                            console.error(error);
                            container.innerHTML = `<div class="alert alert-danger">${error.response.data.error}</div>`;
                            container.style.display = 'block';
                        });
                    });
                }

                window.openExhibApplyModal = openExhibApplyModal;
                window.submitApplication = submitApplication;
                window.openFilterModal = openFilterModal;
                window.submitFilter = submitFilter;
            }
        );
    </script>
{% endblock %}

